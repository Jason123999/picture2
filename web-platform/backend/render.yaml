services:
  - type: web
    name: photo-platform-backend
    env: python
    plan: free
    rootDir: backend
    buildCommand: pip install -r requirements.txt && pip install -r requirements-supabase.txt
    startCommand: uvicorn app.main:app --host 0.0.0.0 --port $PORT
    envVars:
      - key: ENV
        value: production
      - key: API_V1_PREFIX
        value: /api
      - key: JWT_SECRET_KEY
        generateValue: true
      - key: DATABASE_URL
        value: REPLACE_WITH_SUPABASE_POSTGRES_DSN
      - key: STORAGE_BACKEND
        value: supabase
      - key: SUPABASE_URL
        value: REPLACE_WITH_SUPABASE_URL
      - key: SUPABASE_SERVICE_ROLE_KEY
        value: REPLACE_WITH_SUPABASE_SERVICE_ROLE_KEY
      - key: SUPABASE_STORAGE_BUCKET
        value: photo-platform
      - key: SUPABASE_PUBLIC_URL
        value: REPLACE_WITH_SUPABASE_PUBLIC_URL

      # A 模式（泛子域）多租户
      - key: PLATFORM_ROOT_DOMAIN
        value: REPLACE_WITH_ROOT_DOMAIN
      - key: PLATFORM_APP_SUBDOMAIN
        value: app
      - key: PLATFORM_API_SUBDOMAIN
        value: api
      - key: TENANT_HEADER_NAME
        value: x-tenant-slug

      # Option 1: tenant.vercel.app provisioning
      - key: VERCEL_TOKEN
        value: REPLACE_WITH_VERCEL_TOKEN
      - key: VERCEL_TEAM_ID
        value: REPLACE_WITH_VERCEL_TEAM_ID
      - key: VERCEL_TEAM_SLUG
        value: REPLACE_WITH_VERCEL_TEAM_SLUG
      - key: VERCEL_GIT_PROVIDER
        value: github
      - key: VERCEL_GIT_REPO
        value: REPLACE_WITH_GITHUB_ORG_AND_REPO
      - key: VERCEL_GIT_REF
        value: main
      - key: VERCEL_FRONTEND_ROOT_DIR
        value: web-platform/frontend
      - key: VERCEL_FRONTEND_API_BASE_URL
        value: REPLACE_WITH_PUBLIC_BACKEND_API_BASE_URL

      # CORS：方案1 tenant.vercel.app 推荐值：^https://([a-z0-9-]+\.)*vercel\.app$
      - key: CORS_ALLOW_ORIGIN_REGEX
        value: REPLACE_WITH_CORS_ORIGIN_REGEX
